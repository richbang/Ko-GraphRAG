



<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indexing Architecture</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/19.1.1/tooltips.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
html {
    padding: 0;
    margin: 0;
}

body{
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    padding: 0;
    margin: 0;
}

footer{
    width: 100%;
	height: 32px;
	font-size: 12px;
	display: flex;
	flex-direction: row;
	justify-content: center;
	gap: 18px;
	align-items: center;
	color: #5d5d5d;
	background: #e9eaeb;
	border-top: 1px solid #c4c5c6;
}

#cookiesManager{
    cursor: pointer;
    color: #485fc7;
}

.page-content {
    display: flex;
    flex-direction: row;
    margin: 0;
    padding: 0;
    overflow: scroll;
    padding: 0;
    margin: 0;
}

header {
    background-color: lightgrey;
    height: 2%;
    padding: 10px;
}

nav {
    padding: 1em;
    min-width: 200px;
}

main {
    flex: 1;
    padding: 0 5em 0 5em;
}

.logotitle {
    font-size: 1.5em;
    font-weight: bold;
    margin: 5px;
}

.number {
    all: unset;
}

.tag.token {
    all: unset;
}

main ul {
    list-style-type: disc;
    padding-left: 30px;
    margin-top: 10px;
}

h1 {
    font-size: 2rem;
    margin-top: 10px;
}

h2 {
    font-size: 1.5rem;
    margin-top: 10px;
    font-weight: 500;
}

h3 {
    font-size: 1rem;
    margin-top: 10px; 
    font-weight: 500;
}
p {
    margin-top: 10px;
}

/* Accessibility styling */

a {
    color: #485fc7;
    text-decoration: underline;
}

.menu-list a {
    text-decoration: none;
}


.token.comment, .token.prolog, .token.doctype, .token.cdata {
    color: #8093a5;
}

.token.property, .token.tag, .token.constant, .token.symbol, .token.deleted {
    color: #ff36ab;
}
</style>
    <script type="module" async="">import mermaid from "https://unpkg.com/mermaid@10/dist/mermaid.esm.min.mjs";document.addEventListener('DOMContentLoaded', mermaid.initialize({"loadOnSave":true}));</script>
    <script>function showTooltip(o,e){o.trigger.className.includes("tooltipped")||(o.trigger.children[0].className="tooltipped tooltipped-s",o.trigger.children[0].ariaLabel=e)}window.addEventListener("load",()=>{var o=new ClipboardJS(".code-copy");o.on("success",o=>showTooltip(o,"Copied!")),o.on("error",o=>showTooltip(o,"Failed..."))});</script>
<script async="" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>

    
    <script src="https://wcpstatic.microsoft.com/mscc/lib/v2/wcp-consent.js" type="text/javascript"></script>
    <script>
        function onConsentChanged(categoryPreferences) {
            console.log("onConsentChanged", categoryPreferences);        
        }

        var siteConsent

        function initialize(){
          var currentYear = new Date().getFullYear()
          document.getElementById("copyright").innerHTML = `©️ ${currentYear} Microsoft`;
          window.WcpConsent && WcpConsent.init("en-US", "cookie-banner", function (err, _siteConsent) {
              if (!err) {
                  siteConsent = _siteConsent;  //siteConsent is used to get the current consent  
              } else {
                  console.log("Error initializing WcpConsent: "+ err);
              }
          }, onConsentChanged, WcpConsent.themes.light);
        }

        addEventListener("DOMContentLoaded", initialize)
        addEventListener("DOMContentLoaded", checkCookieManager)

        function checkCookieManager(){
          if(siteConsent.isConsentRequired){
            document.getElementById("cookiesManager").style.display = 'block';
            document.getElementById("divider").style.display = 'block';
          }
          else{
            document.getElementById("cookiesManager").style.display = 'none';
            document.getElementById("divider").style.display = 'none';
          }
        }

        function manageConsent() {
        if(siteConsent.isConsentRequired){
            siteConsent.manageConsent();
        }
    }
    </script>
    
  </head>
  <body>
    <header>
        <div id="cookie-banner"></div>
        <a href="/graphrag/"><span class="logotitle">GraphRAG</span></a>
    </header>
    <div class="page-content">
        <!-- Sidebar -->
        <aside class="menu">
          <ul class="menu-list">
            <li>
              
<a href="/graphrag/">Welcome</a>

            </li>

            <!-- Get Started Links -->
            <li>
              
<a href="/graphrag/posts/get_started/">Get Started</a>

              
<a href="/graphrag/posts/developing/">Developing</a>

            </li>

            <!-- Indexing Links -->
            <li>
                
<a href="/graphrag/posts/index/overview/">Indexing</a>

                <ul><li>
<a href="/graphrag/posts/index/0-architecture/" class="is-active" aria-current="page">Architecture</a>
</li><li>
<a href="/graphrag/posts/index/1-default_dataflow/">Dataflow</a>
</li><li>
<a href="/graphrag/posts/index/2-cli/">CLI</a>
</li><li>
                    
<a href="/graphrag/posts/config/overview/">Configuration</a>

                    <ul>
                      <li>
<a href="/graphrag/posts/config/init">Init command</a>
</li>
                      <li>
<a href="/graphrag/posts/config/env_vars">Using Env Vars</a>
</li>
                      <li>
<a href="/graphrag/posts/config/json_yaml">Using JSON or YAML</a>
</li>
                      <li>
<a href="/graphrag/posts/config/custom">Fully Custom</a>
</li>
                      <li>
<a href="/graphrag/posts/config/template">Template</a>
</li>
                    </ul>
                  </li>

                  <li>
                    
<a href="/graphrag/posts/prompt_tuning/overview/">Prompt Tuning</a>

                    <ul>
                        <li>
                            
<a href="/graphrag/posts/prompt_tuning/auto_prompt_tuning/">Auto Tuning</a>

                        </li>
                        <li>
                            
<a href="/graphrag/posts/prompt_tuning/manual_prompt_tuning/">Manual Tuning</a>

                        </li>
                    </ul>
                  </li>
                </ul>
            </li>
            

            <!-- Query Links -->
            <li>
              
<a href="/graphrag/posts/query/overview/">Query</a>

              <ul><li>
<a href="/graphrag/posts/query/1-local_search/">Local Search</a>
</li><li>
<a href="/graphrag/posts/query/2-question_generation/">Question Generation</a>
</li><li>
<a href="/graphrag/posts/query/0-global_search/">Global Search</a>
</li><li>
<a href="/graphrag/posts/query/3-cli/">CLI</a>
</li><li>
                  
<a href="/graphrag/posts/query/notebooks/overview/">Notebooks</a>

                  <ul>
                    <li>
<a href="/graphrag/posts/query/notebooks/global_search_nb">Global Search</a>
</li>
                    <li>
<a href="/graphrag/posts/query/notebooks/local_search_nb">Local Search</a>
</li>
                  </ul>
                </li>
            </ul>
            </li>
          </ul>
        </aside>

        <!-- Main Content -->
        <main>
            <h1>Indexing Architecture</h1>
            <h2>Key Concepts</h2>
<h3>Knowledge Model</h3>
<p>In order to support the GraphRAG system, the outputs of the indexing engine (in the Default Configuration Mode) are aligned to a knowledge model we call the <em>GraphRAG Knowledge Model</em>.
This model is designed to be an abstraction over the underlying data storage technology, and to provide a common interface for the GraphRAG system to interact with.
In normal use-cases the outputs of the GraphRAG Indexer would be loaded into a database system, and the GraphRAG's Query Engine would interact with the database using the knowledge model data-store types.</p>
<h3>DataShaper Workflows</h3>
<p>GraphRAG's Indexing Pipeline is built on top of our open-source library, <a href="https://github.com/microsoft/datashaper">DataShaper</a>.
DataShaper is a data processing library that allows users to declaratively express data pipelines, schemas, and related assets using well-defined schemas.
DataShaper has implementations in JavaScript and Python, and is designed to be extensible to other languages.</p>
<p>One of the core resource types within DataShaper is a <a href="https://github.com/microsoft/datashaper/blob/main/javascript/schema/src/workflow/WorkflowSchema.ts">Workflow</a>.
Workflows are expressed as sequences of steps, which we call <a href="https://github.com/microsoft/datashaper/blob/main/javascript/schema/src/workflow/verbs.ts">verbs</a>.
Each step has a verb name and a configuration object.
In DataShaper, these verbs model relational concepts such as SELECT, DROP, JOIN, etc.. Each verb transforms an input data table, and that table is passed down the pipeline.</p>
<pre class="mermaid">---&#10;title: Sample Workflow&#10;---&#10;flowchart LR&#10;    input[Input Table] --&gt; select[SELECT] --&gt; join[JOIN] --&gt; binarize[BINARIZE] --&gt; output[Output Table]&#10;</pre>
<h3>LLM-based Workflow Steps</h3>
<p>GraphRAG's Indexing Pipeline implements a handful of custom verbs on top of the standard, relational verbs that our DataShaper library provides. These verbs give us the ability to augment text documents with rich, structured data using the power of LLMs such as GPT-4. We utilize these verbs in our standard workflow to extract entities, relationships, claims, community structures, and community reports and summaries. This behavior is customizable and can be extended to support many kinds of AI-based data enrichment and extraction tasks.</p>
<h3>Workflow Graphs</h3>
<p>Because of the complexity of our data indexing tasks, we needed to be able to express our data pipeline as series of multiple, interdependent workflows.
In the GraphRAG Indexing Pipeline, each workflow may define dependencies on other workflows, effectively forming a directed acyclic graph (DAG) of workflows, which is then used to schedule processing.</p>
<pre class="mermaid">---&#10;title: Sample Workflow DAG&#10;---&#10;stateDiagram-v2&#10;    [*] --&gt; Prepare&#10;    Prepare --&gt; Chunk&#10;    Chunk --&gt; ExtractGraph&#10;    Chunk --&gt; EmbedDocuments&#10;    ExtractGraph --&gt; GenerateReports&#10;    ExtractGraph --&gt; EmbedEntities&#10;    ExtractGraph --&gt; EmbedGraph&#10;</pre>
<h3>Dataframe Message Format</h3>
<p>The primary unit of communication between workflows, and between workflow steps is an instance of <code>pandas.DataFrame</code>.
Although side-effects are possible, our goal is to be <em>data-centric</em> and <em>table-centric</em> in our approach to data processing.
This allows us to easily reason about our data, and to leverage the power of dataframe-based ecosystems.
Our underlying dataframe technology may change over time, but our primary goal is to support the DataShaper workflow schema while retaining single-machine ease of use and developer ergonomics.</p>
<h3>LLM Caching</h3>
<p>The GraphRAG library was designed with LLM interactions in mind, and a common setback when working with LLM APIs is various errors due to network latency, throttling, etc..
Because of these potential error cases, we've added a cache layer around LLM interactions.
When completion requests are made using the same input set (prompt and tuning parameters), we return a cached result if one exists.
This allows our indexer to be more resilient to network issues, to act idempotently, and to provide a more efficient end-user experience.</p>

        </main>
    </div>
    <footer>
      <a href="https://go.microsoft.com/fwlink/?LinkId=521839">Privacy</a>
      |
      <a href="https://go.microsoft.com/fwlink/?LinkId=2259814">Consumer Health Privacy</a>
      |
      <span id="cookiesManager" onClick="manageConsent();">Cookies</span>
      <span id="divider">|</span>
      <a href="https://go.microsoft.com/fwlink/?LinkID=206977">Terms of Use</a>
      |
      <a href="https://www.microsoft.com/trademarks">Trademarks</a>
      |
      <a href="https://www.microsoft.com" id="copyright"></a>
      |
      <a href="https://github.com/microsoft/graphrag">GitHub</a>
      |
      <a href="https://github.com/Azure-Samples/graphrag-accelerator">Solution Accelerator</a>
    </footer>    
  </body>
</html>