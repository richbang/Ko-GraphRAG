



<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/19.1.1/tooltips.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
html {
    padding: 0;
    margin: 0;
}

body{
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    padding: 0;
    margin: 0;
}

footer{
    width: 100%;
	height: 32px;
	font-size: 12px;
	display: flex;
	flex-direction: row;
	justify-content: center;
	gap: 18px;
	align-items: center;
	color: #5d5d5d;
	background: #e9eaeb;
	border-top: 1px solid #c4c5c6;
}

#cookiesManager{
    cursor: pointer;
    color: #485fc7;
}

.page-content {
    display: flex;
    flex-direction: row;
    margin: 0;
    padding: 0;
    overflow: scroll;
    padding: 0;
    margin: 0;
}

header {
    background-color: lightgrey;
    height: 2%;
    padding: 10px;
}

nav {
    padding: 1em;
    min-width: 200px;
}

main {
    flex: 1;
    padding: 0 5em 0 5em;
}

.logotitle {
    font-size: 1.5em;
    font-weight: bold;
    margin: 5px;
}

.number {
    all: unset;
}

.tag.token {
    all: unset;
}

main ul {
    list-style-type: disc;
    padding-left: 30px;
    margin-top: 10px;
}

h1 {
    font-size: 2rem;
    margin-top: 10px;
}

h2 {
    font-size: 1.5rem;
    margin-top: 10px;
    font-weight: 500;
}

h3 {
    font-size: 1rem;
    margin-top: 10px; 
    font-weight: 500;
}
p {
    margin-top: 10px;
}

/* Accessibility styling */

a {
    color: #485fc7;
    text-decoration: underline;
}

.menu-list a {
    text-decoration: none;
}


.token.comment, .token.prolog, .token.doctype, .token.cdata {
    color: #8093a5;
}

.token.property, .token.tag, .token.constant, .token.symbol, .token.deleted {
    color: #ff36ab;
}
</style>
    <script type="module" async="">import mermaid from "https://unpkg.com/mermaid@10/dist/mermaid.esm.min.mjs";document.addEventListener('DOMContentLoaded', mermaid.initialize({"loadOnSave":true}));</script>
    <script>function showTooltip(o,e){o.trigger.className.includes("tooltipped")||(o.trigger.children[0].className="tooltipped tooltipped-s",o.trigger.children[0].ariaLabel=e)}window.addEventListener("load",()=>{var o=new ClipboardJS(".code-copy");o.on("success",o=>showTooltip(o,"Copied!")),o.on("error",o=>showTooltip(o,"Failed..."))});</script>
<script async="" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>

    
    <script src="https://wcpstatic.microsoft.com/mscc/lib/v2/wcp-consent.js" type="text/javascript"></script>
    <script>
        function onConsentChanged(categoryPreferences) {
            console.log("onConsentChanged", categoryPreferences);        
        }

        var siteConsent

        function initialize(){
          var currentYear = new Date().getFullYear()
          document.getElementById("copyright").innerHTML = `©️ ${currentYear} Microsoft`;
          window.WcpConsent && WcpConsent.init("en-US", "cookie-banner", function (err, _siteConsent) {
              if (!err) {
                  siteConsent = _siteConsent;  //siteConsent is used to get the current consent  
              } else {
                  console.log("Error initializing WcpConsent: "+ err);
              }
          }, onConsentChanged, WcpConsent.themes.light);
        }

        addEventListener("DOMContentLoaded", initialize)
        addEventListener("DOMContentLoaded", checkCookieManager)

        function checkCookieManager(){
          if(siteConsent.isConsentRequired){
            document.getElementById("cookiesManager").style.display = 'block';
            document.getElementById("divider").style.display = 'block';
          }
          else{
            document.getElementById("cookiesManager").style.display = 'none';
            document.getElementById("divider").style.display = 'none';
          }
        }

        function manageConsent() {
        if(siteConsent.isConsentRequired){
            siteConsent.manageConsent();
        }
    }
    </script>
    
  </head>
  <body>
    <header>
        <div id="cookie-banner"></div>
        <a href="/graphrag/"><span class="logotitle">GraphRAG</span></a>
    </header>
    <div class="page-content">
        <!-- Sidebar -->
        <aside class="menu">
          <ul class="menu-list">
            <li>
              
<a href="/graphrag/">Welcome</a>

            </li>

            <!-- Get Started Links -->
            <li>
              
<a href="/graphrag/posts/get_started/">Get Started</a>

              
<a href="/graphrag/posts/developing/">Developing</a>

            </li>

            <!-- Indexing Links -->
            <li>
                
<a href="/graphrag/posts/index/overview/">Indexing</a>

                <ul><li>
<a href="/graphrag/posts/index/0-architecture/">Architecture</a>
</li><li>
<a href="/graphrag/posts/index/1-default_dataflow/">Dataflow</a>
</li><li>
<a href="/graphrag/posts/index/2-cli/">CLI</a>
</li><li>
                    
<a href="/graphrag/posts/config/overview/">Configuration</a>

                    <ul>
                      <li>
<a href="/graphrag/posts/config/init">Init command</a>
</li>
                      <li>
<a href="/graphrag/posts/config/env_vars">Using Env Vars</a>
</li>
                      <li>
<a href="/graphrag/posts/config/json_yaml">Using JSON or YAML</a>
</li>
                      <li>
<a href="/graphrag/posts/config/custom">Fully Custom</a>
</li>
                      <li>
<a href="/graphrag/posts/config/template">Template</a>
</li>
                    </ul>
                  </li>

                  <li>
                    
<a href="/graphrag/posts/prompt_tuning/overview/">Prompt Tuning</a>

                    <ul>
                        <li>
                            
<a href="/graphrag/posts/prompt_tuning/auto_prompt_tuning/">Auto Tuning</a>

                        </li>
                        <li>
                            
<a href="/graphrag/posts/prompt_tuning/manual_prompt_tuning/">Manual Tuning</a>

                        </li>
                    </ul>
                  </li>
                </ul>
            </li>
            

            <!-- Query Links -->
            <li>
              
<a href="/graphrag/posts/query/overview/">Query</a>

              <ul><li>
<a href="/graphrag/posts/query/1-local_search/">Local Search</a>
</li><li>
<a href="/graphrag/posts/query/2-question_generation/">Question Generation</a>
</li><li>
<a href="/graphrag/posts/query/0-global_search/">Global Search</a>
</li><li>
<a href="/graphrag/posts/query/3-cli/">CLI</a>
</li><li>
                  
<a href="/graphrag/posts/query/notebooks/overview/">Notebooks</a>

                  <ul>
                    <li>
<a href="/graphrag/posts/query/notebooks/global_search_nb">Global Search</a>
</li>
                    <li>
<a href="/graphrag/posts/query/notebooks/local_search_nb">Local Search</a>
</li>
                  </ul>
                </li>
            </ul>
            </li>
          </ul>
        </aside>

        <!-- Main Content -->
        <main>
            <h1></h1>
            
<div style="position: relative">
  <pre class="language-python"><code id="code-0" class="language-python"><span class="token comment"># Copyright (c) 2024 Microsoft Corporation.</span>
<span class="token comment"># Licensed under the MIT License.</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-0" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-1" class="language-python"><span class="token keyword">import</span> os

<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> tiktoken

<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>context_builder<span class="token punctuation">.</span>entity_extraction <span class="token keyword">import</span> EntityVectorStoreKey
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>indexer_adapters <span class="token keyword">import</span> <span class="token punctuation">(</span>
    read_indexer_covariates<span class="token punctuation">,</span>
    read_indexer_entities<span class="token punctuation">,</span>
    read_indexer_relationships<span class="token punctuation">,</span>
    read_indexer_reports<span class="token punctuation">,</span>
    read_indexer_text_units<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">.</span>loaders<span class="token punctuation">.</span>dfs <span class="token keyword">import</span> <span class="token punctuation">(</span>
    store_entity_semantic_embeddings<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>oai<span class="token punctuation">.</span>chat_openai <span class="token keyword">import</span> ChatOpenAI
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>oai<span class="token punctuation">.</span>embedding <span class="token keyword">import</span> OpenAIEmbedding
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>oai<span class="token punctuation">.</span>typing <span class="token keyword">import</span> OpenaiApiType
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>question_gen<span class="token punctuation">.</span>local_gen <span class="token keyword">import</span> LocalQuestionGen
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>structured_search<span class="token punctuation">.</span>local_search<span class="token punctuation">.</span>mixed_context <span class="token keyword">import</span> <span class="token punctuation">(</span>
    LocalSearchMixedContext<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>structured_search<span class="token punctuation">.</span>local_search<span class="token punctuation">.</span>search <span class="token keyword">import</span> LocalSearch
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>vector_stores<span class="token punctuation">.</span>lancedb <span class="token keyword">import</span> LanceDBVectorStore</code></pre>

  <button class="code-copy " data-clipboard-target="#code-1" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h2>Local Search Example</h2>
<p>Local search method generates answers by combining relevant data from the AI-extracted knowledge-graph with text chunks of the raw documents. This method is suitable for questions that require an understanding of specific entities mentioned in the documents (e.g. What are the healing properties of chamomile?).</p>
<h3>Load text units and graph data tables as context for local search</h3>
<ul>
<li>In this test we first load indexing outputs from parquet files to dataframes, then convert these dataframes into collections of data objects aligning with the knowledge model.</li>
</ul>
<h3>Load tables to dataframes</h3>

<div style="position: relative">
  <pre class="language-python"><code id="code-21" class="language-python">INPUT_DIR <span class="token operator">=</span> <span class="token string">"./inputs/operation dulce"</span>
LANCEDB_URI <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/lancedb"</span></span>

COMMUNITY_REPORT_TABLE <span class="token operator">=</span> <span class="token string">"create_final_community_reports"</span>
ENTITY_TABLE <span class="token operator">=</span> <span class="token string">"create_final_nodes"</span>
ENTITY_EMBEDDING_TABLE <span class="token operator">=</span> <span class="token string">"create_final_entities"</span>
RELATIONSHIP_TABLE <span class="token operator">=</span> <span class="token string">"create_final_relationships"</span>
COVARIATE_TABLE <span class="token operator">=</span> <span class="token string">"create_final_covariates"</span>
TEXT_UNIT_TABLE <span class="token operator">=</span> <span class="token string">"create_final_text_units"</span>
COMMUNITY_LEVEL <span class="token operator">=</span> <span class="token number">2</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-21" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Read entities</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-25" class="language-python"><span class="token comment"># read nodes table to get community and degree data</span>
entity_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>ENTITY_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>
entity_embedding_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>ENTITY_EMBEDDING_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>

entities <span class="token operator">=</span> read_indexer_entities<span class="token punctuation">(</span>entity_df<span class="token punctuation">,</span> entity_embedding_df<span class="token punctuation">,</span> COMMUNITY_LEVEL<span class="token punctuation">)</span>

<span class="token comment"># load description embeddings to an in-memory lancedb vectorstore</span>
<span class="token comment"># to connect to a remote db, specify url and port values.</span>
description_embedding_store <span class="token operator">=</span> LanceDBVectorStore<span class="token punctuation">(</span>
    collection_name<span class="token operator">=</span><span class="token string">"entity_description_embeddings"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
description_embedding_store<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>db_uri<span class="token operator">=</span>LANCEDB_URI<span class="token punctuation">)</span>
entity_description_embeddings <span class="token operator">=</span> store_entity_semantic_embeddings<span class="token punctuation">(</span>
    entities<span class="token operator">=</span>entities<span class="token punctuation">,</span> vectorstore<span class="token operator">=</span>description_embedding_store
<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Entity count: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>entity_df<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
entity_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-25" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Read relationships</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-29" class="language-python">relationship_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>RELATIONSHIP_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>
relationships <span class="token operator">=</span> read_indexer_relationships<span class="token punctuation">(</span>relationship_df<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Relationship count: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>relationship_df<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
relationship_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-29" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-30" class="language-python"><span class="token comment"># NOTE: covariates are turned off by default, because they generally need prompt tuning to be valuable</span>
<span class="token comment"># Please see the GRAPHRAG_CLAIM_* settings</span>
covariate_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>COVARIATE_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>

claims <span class="token operator">=</span> read_indexer_covariates<span class="token punctuation">(</span>covariate_df<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Claim records: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
covariates <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"claims"</span><span class="token punctuation">:</span> claims<span class="token punctuation">}</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-30" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Read community reports</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-34" class="language-python">report_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>COMMUNITY_REPORT_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>
reports <span class="token operator">=</span> read_indexer_reports<span class="token punctuation">(</span>report_df<span class="token punctuation">,</span> entity_df<span class="token punctuation">,</span> COMMUNITY_LEVEL<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Report records: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>report_df<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
report_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-34" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Read text units</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-38" class="language-python">text_unit_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>TEXT_UNIT_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>
text_units <span class="token operator">=</span> read_indexer_text_units<span class="token punctuation">(</span>text_unit_df<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Text unit records: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>text_unit_df<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
text_unit_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-38" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-39" class="language-python">api_key <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"GRAPHRAG_API_KEY"</span><span class="token punctuation">]</span>
llm_model <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"GRAPHRAG_LLM_MODEL"</span><span class="token punctuation">]</span>
embedding_model <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"GRAPHRAG_EMBEDDING_MODEL"</span><span class="token punctuation">]</span>

llm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>
    api_key<span class="token operator">=</span>api_key<span class="token punctuation">,</span>
    model<span class="token operator">=</span>llm_model<span class="token punctuation">,</span>
    api_type<span class="token operator">=</span>OpenaiApiType<span class="token punctuation">.</span>OpenAI<span class="token punctuation">,</span>  <span class="token comment"># OpenaiApiType.OpenAI or OpenaiApiType.AzureOpenAI</span>
    max_retries<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

token_encoder <span class="token operator">=</span> tiktoken<span class="token punctuation">.</span>get_encoding<span class="token punctuation">(</span><span class="token string">"cl100k_base"</span><span class="token punctuation">)</span>

text_embedder <span class="token operator">=</span> OpenAIEmbedding<span class="token punctuation">(</span>
    api_key<span class="token operator">=</span>api_key<span class="token punctuation">,</span>
    api_base<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    api_type<span class="token operator">=</span>OpenaiApiType<span class="token punctuation">.</span>OpenAI<span class="token punctuation">,</span>
    model<span class="token operator">=</span>embedding_model<span class="token punctuation">,</span>
    deployment_name<span class="token operator">=</span>embedding_model<span class="token punctuation">,</span>
    max_retries<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-39" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h3>Create local search context builder</h3>

<div style="position: relative">
  <pre class="language-python"><code id="code-43" class="language-python">context_builder <span class="token operator">=</span> LocalSearchMixedContext<span class="token punctuation">(</span>
    community_reports<span class="token operator">=</span>reports<span class="token punctuation">,</span>
    text_units<span class="token operator">=</span>text_units<span class="token punctuation">,</span>
    entities<span class="token operator">=</span>entities<span class="token punctuation">,</span>
    relationships<span class="token operator">=</span>relationships<span class="token punctuation">,</span>
    <span class="token comment"># if you did not run covariates during indexing, set this to None</span>
    covariates<span class="token operator">=</span>covariates<span class="token punctuation">,</span>
    entity_text_embeddings<span class="token operator">=</span>description_embedding_store<span class="token punctuation">,</span>
    embedding_vectorstore_key<span class="token operator">=</span>EntityVectorStoreKey<span class="token punctuation">.</span>ID<span class="token punctuation">,</span>  <span class="token comment"># if the vectorstore uses entity title as ids, set this to EntityVectorStoreKey.TITLE</span>
    text_embedder<span class="token operator">=</span>text_embedder<span class="token punctuation">,</span>
    token_encoder<span class="token operator">=</span>token_encoder<span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-43" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h3>Create local search engine</h3>

<div style="position: relative">
  <pre class="language-python"><code id="code-47" class="language-python"><span class="token comment"># text_unit_prop: proportion of context window dedicated to related text units</span>
<span class="token comment"># community_prop: proportion of context window dedicated to community reports.</span>
<span class="token comment"># The remaining proportion is dedicated to entities and relationships. Sum of text_unit_prop and community_prop should be &lt;= 1</span>
<span class="token comment"># conversation_history_max_turns: maximum number of turns to include in the conversation history.</span>
<span class="token comment"># conversation_history_user_turns_only: if True, only include user queries in the conversation history.</span>
<span class="token comment"># top_k_mapped_entities: number of related entities to retrieve from the entity description embedding store.</span>
<span class="token comment"># top_k_relationships: control the number of out-of-network relationships to pull into the context window.</span>
<span class="token comment"># include_entity_rank: if True, include the entity rank in the entity table in the context window. Default entity rank = node degree.</span>
<span class="token comment"># include_relationship_weight: if True, include the relationship weight in the context window.</span>
<span class="token comment"># include_community_rank: if True, include the community rank in the context window.</span>
<span class="token comment"># return_candidate_context: if True, return a set of dataframes containing all candidate entity/relationship/covariate records that</span>
<span class="token comment"># could be relevant. Note that not all of these records will be included in the context window. The "in_context" column in these</span>
<span class="token comment"># dataframes indicates whether the record is included in the context window.</span>
<span class="token comment"># max_tokens: maximum number of tokens to use for the context window.</span>


local_context_params <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"text_unit_prop"</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token string">"community_prop"</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
    <span class="token string">"conversation_history_max_turns"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string">"conversation_history_user_turns_only"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">"top_k_mapped_entities"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string">"top_k_relationships"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string">"include_entity_rank"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">"include_relationship_weight"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">"include_community_rank"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token string">"return_candidate_context"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token string">"embedding_vectorstore_key"</span><span class="token punctuation">:</span> EntityVectorStoreKey<span class="token punctuation">.</span>ID<span class="token punctuation">,</span>  <span class="token comment"># set this to EntityVectorStoreKey.TITLE if the vectorstore uses entity title as ids</span>
    <span class="token string">"max_tokens"</span><span class="token punctuation">:</span> <span class="token number">12_000</span><span class="token punctuation">,</span>  <span class="token comment"># change this based on the token limit you have on your model (if you are using a model with 8k limit, a good setting could be 5000)</span>
<span class="token punctuation">}</span>

llm_params <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"max_tokens"</span><span class="token punctuation">:</span> <span class="token number">2_000</span><span class="token punctuation">,</span>  <span class="token comment"># change this based on the token limit you have on your model (if you are using a model with 8k limit, a good setting could be 1000=1500)</span>
    <span class="token string">"temperature"</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-47" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-48" class="language-python">search_engine <span class="token operator">=</span> LocalSearch<span class="token punctuation">(</span>
    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
    context_builder<span class="token operator">=</span>context_builder<span class="token punctuation">,</span>
    token_encoder<span class="token operator">=</span>token_encoder<span class="token punctuation">,</span>
    llm_params<span class="token operator">=</span>llm_params<span class="token punctuation">,</span>
    context_builder_params<span class="token operator">=</span>local_context_params<span class="token punctuation">,</span>
    response_type<span class="token operator">=</span><span class="token string">"multiple paragraphs"</span><span class="token punctuation">,</span>  <span class="token comment"># free form text describing the response type and format, can be anything, e.g. prioritized list, single paragraph, multiple paragraphs, multiple-page report</span>
<span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-48" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h3>Run local search on sample queries</h3>

<div style="position: relative">
  <pre class="language-python"><code id="code-52" class="language-python">result <span class="token operator">=</span> <span class="token keyword">await</span> search_engine<span class="token punctuation">.</span>asearch<span class="token punctuation">(</span><span class="token string">"Tell me about Agent Mercer"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>response<span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-52" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-53" class="language-python">question <span class="token operator">=</span> <span class="token string">"Tell me about Dr. Jordan Hayes"</span>
result <span class="token operator">=</span> <span class="token keyword">await</span> search_engine<span class="token punctuation">.</span>asearch<span class="token punctuation">(</span>question<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>response<span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-53" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Inspecting the context data used to generate the response</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-57" class="language-python">result<span class="token punctuation">.</span>context_data<span class="token punctuation">[</span><span class="token string">"entities"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-57" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-58" class="language-python">result<span class="token punctuation">.</span>context_data<span class="token punctuation">[</span><span class="token string">"relationships"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-58" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-59" class="language-python">result<span class="token punctuation">.</span>context_data<span class="token punctuation">[</span><span class="token string">"reports"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-59" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-60" class="language-python">result<span class="token punctuation">.</span>context_data<span class="token punctuation">[</span><span class="token string">"sources"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-60" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-61" class="language-python"><span class="token keyword">if</span> <span class="token string">"claims"</span> <span class="token keyword">in</span> result<span class="token punctuation">.</span>context_data<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>context_data<span class="token punctuation">[</span><span class="token string">"claims"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-61" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h3>Question Generation</h3>
<p>This function takes a list of user queries and generates the next candidate questions.</p>

<div style="position: relative">
  <pre class="language-python"><code id="code-68" class="language-python">question_generator <span class="token operator">=</span> LocalQuestionGen<span class="token punctuation">(</span>
    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
    context_builder<span class="token operator">=</span>context_builder<span class="token punctuation">,</span>
    token_encoder<span class="token operator">=</span>token_encoder<span class="token punctuation">,</span>
    llm_params<span class="token operator">=</span>llm_params<span class="token punctuation">,</span>
    context_builder_params<span class="token operator">=</span>local_context_params<span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-68" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-69" class="language-python">question_history <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"Tell me about Agent Mercer"</span><span class="token punctuation">,</span>
    <span class="token string">"What happens in Dulce military base?"</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
candidate_questions <span class="token operator">=</span> <span class="token keyword">await</span> question_generator<span class="token punctuation">.</span>agenerate<span class="token punctuation">(</span>
    question_history<span class="token operator">=</span>question_history<span class="token punctuation">,</span> context_data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> question_count<span class="token operator">=</span><span class="token number">5</span>
<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>candidate_questions<span class="token punctuation">.</span>response<span class="token punctuation">)</span></code></pre>

  <button class="code-copy " data-clipboard-target="#code-69" style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

        </main>
    </div>
    <footer>
      <a href="https://go.microsoft.com/fwlink/?LinkId=521839">Privacy</a>
      |
      <a href="https://go.microsoft.com/fwlink/?LinkId=2259814">Consumer Health Privacy</a>
      |
      <span id="cookiesManager" onClick="manageConsent();">Cookies</span>
      <span id="divider">|</span>
      <a href="https://go.microsoft.com/fwlink/?LinkID=206977">Terms of Use</a>
      |
      <a href="https://www.microsoft.com/trademarks">Trademarks</a>
      |
      <a href="https://www.microsoft.com" id="copyright"></a>
      |
      <a href="https://github.com/microsoft/graphrag">GitHub</a>
      |
      <a href="https://github.com/Azure-Samples/graphrag-accelerator">Solution Accelerator</a>
    </footer>    
  </body>
</html>